name: Generate and publish Aksjesimulator Kotlin models to GitHub Packages

on:
  push:
    branches: 
      - main
    paths: 
      - models/openapi.yaml


jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2.1.5
      - name: Install openapi-generator
        run: |
          cd models
          npm install @openapitools/openapi-generator-cli
      - name: Generate docs
        run: |
          cd models
          npx @openapitools/openapi-generator-cli generate \
            -g kotlin \
            -i openapi.yaml \
            -o generated-kotlin
      - name: Commit and push generated models
        run: |
          git config --global user.name generate-models-bot
          git config --global user.email generate-models-bot@users.noreply.github.com
          git add models/generated-kotlin/*
          git commit -m "Generated models updated according to latest spec"
          git push
      - name: Build and publish Gradle package
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd models/generated-kotlin
          ./gradlew build
          ./gradlew publish